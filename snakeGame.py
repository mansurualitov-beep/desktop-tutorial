""" Игра Змейка на Pygame
Управление: стрелки или WASD
P — пауза, R — рестарт, ESC — выход
"""

import pygame
import random
import sys

# ═══════════════════════════════════════════════════
# НАСТРОЙКИ ИГРЫ — меняй эти цифры как хочешь
# ═══════════════════════════════════════════════════

ШИРИНА   = 600   # ширина окна в пикселях
ВЫСОТА   = 600   # высота окна в пикселях
КЛЕТКА   = 20    # размер одной клетки сетки
СКОРОСТЬ = 10    # кадров в секунду (чем больше — тем быстрее)

# Количество клеток по горизонтали и вертикали
КОЛОНОК = ШИРИНА // КЛЕТКА
СТРОК   = ВЫСОТА // КЛЕТКА

# Цвета в формате (красный, зелёный, синий)
ЧЕРНЫЙ         = (0,   0,   0)
БЕЛЫЙ          = (255, 255, 255)
ЗЕЛЕНЫЙ        = (39,  174, 96)
ТЕМНО_ЗЕЛЕНЫЙ  = (30,  130, 76)
КРАСНЫЙ        = (231, 76,  60)
ТЕМНО_КРАСНЫЙ  = (192, 57,  43)
СЕРЫЙ          = (40,  40,  40)
ТЕМНО_СЕРЫЙ    = (25,  25,  25)
ЖЕЛТЫЙ         = (241, 196, 15)
СИНИЙ          = (52,  152, 219)

# Направления движения (изменение x, изменение y)
ВВЕРХ  = (0,  -1)
ВНИЗ   = (0,   1)
ВЛЕВО  = (-1,  0)
ВПРАВО = (1,   0)


# ═══════════════════════════════════════════════════
# ЗМЕЙКА
# ═══════════════════════════════════════════════════

class Змейка:
    def __init__(self):
        self.сбросить()

    def сбросить(self):
        # Стартуем с середины экрана
        x = КОЛОНОК // 2
        y = СТРОК   // 2

        # Тело — список клеток. Первый элемент = голова
        self.тело = [(x, y), (x-1, y), (x-2, y)]

        # Текущее направление и то, куда повернём на следующем шаге
        self.направление      = ВПРАВО
        self.след_направление = ВПРАВО

        # Если True — на следующем шаге хвост не удаляем (змейка растёт)
        self.растет = False

    def повернуть(self, новое_направление):
        # Нельзя повернуть ровно назад — проверяем противоположное направление
        противоположное = (-новое_направление[0], -новое_направление[1])
        if self.направление != противоположное:
            self.след_направление = новое_направление

    def двигаться(self):
        # Применяем запланированный поворот
        self.направление = self.след_направление

        # Вычисляем позицию новой головы
        голова_x, голова_y = self.тело[0]
        dx, dy = self.направление
        новая_голова = (голова_x + dx, голова_y + dy)

        # Добавляем новую голову в начало тела
        self.тело.insert(0, новая_голова)

        # Убираем хвост только если не растём
        if not self.растет:
            self.тело.pop()
        else:
            self.растет = False

    def съесть(self):
        # На следующем шаге хвост не удалится — змейка вырастет
        self.растет = True

    def столкновение(self):
        голова_x, голова_y = self.тело[0]

        # Вышла за границы экрана?
        if голова_x < 0 or голова_x >= КОЛОНОК:
            return True
        if голова_y < 0 or голова_y >= СТРОК:
            return True

        # Врезалась в своё тело?
        if self.тело[0] in self.тело[1:]:
            return True

        return False

    def нарисовать(self, экран):
        for i, (x, y) in enumerate(self.тело):
            rect = pygame.Rect(x * КЛЕТКА, y * КЛЕТКА, КЛЕТКА, КЛЕТКА)

            if i == 0:
                # Голова — светлее и с глазами
                pygame.draw.rect(экран, ЗЕЛЕНЫЙ, rect, border_radius=5)
                self._глаза(экран, x, y)
            else:
                # Тело — тёмный фон и светлый квадратик внутри
                pygame.draw.rect(экран, ТЕМНО_ЗЕЛЕНЫЙ, rect, border_radius=3)
                pygame.draw.rect(экран, ЗЕЛЕНЫЙ, rect.inflate(-6, -6), border_radius=2)

    def _глаза(self, экран, x, y):
        # Центр головы в пикселях
        cx = x * КЛЕТКА + КЛЕТКА // 2
        cy = y * КЛЕТКА + КЛЕТКА // 2
        dx, dy = self.направление

        # Позиции глаз зависят от направления движения
        if   dx ==  1: г1, г2 = (cx+4, cy-4), (cx+4, cy+4)  # вправо
        elif dx == -1: г1, г2 = (cx-4, cy-4), (cx-4, cy+4)  # влево
        elif dy == -1: г1, г2 = (cx-4, cy-4), (cx+4, cy-4)  # вверх
        else:          г1, г2 = (cx-4, cy+4), (cx+4, cy+4)  # вниз

        pygame.draw.circle(экран, БЕЛЫЙ,  г1, 3)  # белок
        pygame.draw.circle(экран, БЕЛЫЙ,  г2, 3)
        pygame.draw.circle(экран, ЧЕРНЫЙ, г1, 1)  # зрачок
        pygame.draw.circle(экран, ЧЕРНЫЙ, г2, 1)


# ═══════════════════════════════════════════════════
# ЕДА
# ═══════════════════════════════════════════════════

class Еда:
    def __init__(self, тело_змейки):
        self.позиция = self._случайное_место(тело_змейки)
        self.бонус   = False  # бонусная еда даёт 5 очков вместо 1
        self.таймер  = 0      # сколько ходов живёт бонусная еда

    def _случайное_место(self, тело_змейки):
        # Генерируем позицию пока она не окажется на свободной клетке
        while True:
            pos = (random.randint(0, КОЛОНОК-1), random.randint(0, СТРОК-1))
            if pos not in тело_змейки:
                return pos

    def переместить(self, тело_змейки):
        # Змейка съела еду — перемещаем в новое место
        self.позиция = self._случайное_место(тело_змейки)

        # С шансом 25% новая еда будет бонусной
        self.бонус  = random.random() < 0.25
        self.таймер = 80 if self.бонус else 0

    def обновить(self):
        # Уменьшаем таймер, при 0 бонус исчезает
        if self.бонус and self.таймер > 0:
            self.таймер -= 1
            if self.таймер == 0:
                self.бонус = False

    def нарисовать(self, экран):
        x, y = self.позиция
        cx = x * КЛЕТКА + КЛЕТКА // 2
        cy = y * КЛЕТКА + КЛЕТКА // 2
        r  = КЛЕТКА // 2 - 2

        if self.бонус:
            # Бонусная еда — жёлтая и мигает
            pygame.draw.circle(экран, ЖЕЛТЫЙ, (cx, cy), r)
            pygame.draw.circle(экран, БЕЛЫЙ,  (cx, cy), r - 5)
            pygame.draw.circle(экран, ЖЕЛТЫЙ, (cx, cy), r - 8)
            if self.таймер % 16 < 8:  # мигаем каждые 8 кадров
                pygame.draw.circle(экран, БЕЛЫЙ, (cx, cy), r + 2, 2)
        else:
            # Обычная еда — красный кружок с бликом
            pygame.draw.circle(экран, ТЕМНО_КРАСНЫЙ, (cx, cy), r)
            pygame.draw.circle(экран, КРАСНЫЙ,       (cx, cy), r - 2)
            pygame.draw.circle(экран, БЕЛЫЙ,          (cx-3, cy-3), 2)  # блик


# ═══════════════════════════════════════════════════
# ЗАПУСК ИГРЫ
# ═══════════════════════════════════════════════════

def запустить():
    pygame.init()
    экран = pygame.display.set_mode((ШИРИНА, ВЫСОТА))
    pygame.display.set_caption("Змейка")
    часы = pygame.time.Clock()

    # Шрифты разных размеров
    шрифт_большой = pygame.font.SysFont("Arial", 52, bold=True)
    шрифт_средний = pygame.font.SysFont("Arial", 28)
    шрифт_малый   = pygame.font.SysFont("Arial", 18)

    # Создаём объекты игры
    змейка = Змейка()
    еда    = Еда(змейка.тело)

    счет       = 0
    рекорд     = 0
    пауза      = False
    конец      = False
    скорость   = СКОРОСТЬ

    # ── Главный цикл ───────────────────────────────────────
    while True:

        # 1. Обрабатываем нажатия клавиш
        for событие in pygame.event.get():
            if событие.type == pygame.QUIT:
                pygame.quit()
                sys.exit()

            if событие.type == pygame.KEYDOWN:
                if   событие.key in (pygame.K_UP,    pygame.K_w): змейка.повернуть(ВВЕРХ)
                elif событие.key in (pygame.K_DOWN,  pygame.K_s): змейка.повернуть(ВНИЗ)
                elif событие.key in (pygame.K_LEFT,  pygame.K_a): змейка.повернуть(ВЛЕВО)
                elif событие.key in (pygame.K_RIGHT, pygame.K_d): змейка.повернуть(ВПРАВО)
                elif событие.key == pygame.K_p:
                    пауза = not пауза   # переключаем паузу
                elif событие.key == pygame.K_r:
                    # Полный перезапуск игры
                    змейка   = Змейка()
                    еда      = Еда(змейка.тело)
                    счет     = 0
                    скорость = СКОРОСТЬ
                    пауза    = False
                    конец    = False
                elif событие.key == pygame.K_ESCAPE:
                    pygame.quit()
                    sys.exit()

        # 2. Обновляем состояние игры (только если не пауза и не конец)
        if not пауза and not конец:
            змейка.двигаться()
            еда.обновить()

            # Змейка добралась до еды
            if змейка.тело[0] == еда.позиция:
                змейка.съесть()
                счет   += 5 if еда.бонус else 1   # бонусная еда дороже
                рекорд  = max(счет, рекорд)
                еда.переместить(змейка.тело)
                скорость = СКОРОСТЬ + счет // 5   # ускоряемся каждые 5 очков

            # Проверяем столкновение — если да, игра заканчивается
            if змейка.столкновение():
                конец = True

        # 3. Рисуем всё на экране
        экран.fill(ТЕМНО_СЕРЫЙ)

        # Сетка (тонкие линии между клетками)
        for x in range(0, ШИРИНА, КЛЕТКА):
            pygame.draw.line(экран, СЕРЫЙ, (x, 0), (x, ВЫСОТА))
        for y in range(0, ВЫСОТА, КЛЕТКА):
            pygame.draw.line(экран, СЕРЫЙ, (0, y), (ШИРИНА, y))

        # Рисуем еду и змейку
        еда.нарисовать(экран)
        змейка.нарисовать(экран)

        # Счёт и рекорд в левом верхнем углу
        экран.blit(шрифт_средний.render(f"Счёт: {счет}",       True, БЕЛЫЙ), (10, 10))
        экран.blit(шрифт_малый.render(  f"Рекорд: {рекорд}",   True, СИНИЙ), (10, 44))
        экран.blit(шрифт_малый.render(  f"Скорость: {скорость}", True, СЕРЫЙ), (10, 66))

        # Подсказки в правом верхнем углу
        hint = шрифт_малый.render("P — пауза  |  R — рестарт  |  ESC — выход", True, СЕРЫЙ)
        экран.blit(hint, (ШИРИНА - hint.get_width() - 10, 10))

        # Полупрозрачный экран паузы
        if пауза:
            затемнение = pygame.Surface((ШИРИНА, ВЫСОТА), pygame.SRCALPHA)
            затемнение.fill((0, 0, 0, 150))
            экран.blit(затемнение, (0, 0))
            т1 = шрифт_большой.render("ПАУЗА", True, ЖЕЛТЫЙ)
            т2 = шрифт_средний.render("Нажми P чтобы продолжить", True, БЕЛЫЙ)
            экран.blit(т1, (ШИРИНА//2 - т1.get_width()//2, ВЫСОТА//2 - 50))
            экран.blit(т2, (ШИРИНА//2 - т2.get_width()//2, ВЫСОТА//2 + 20))

        # Полупрозрачный экран конца игры
        if конец:
            затемнение = pygame.Surface((ШИРИНА, ВЫСОТА), pygame.SRCALPHA)
            затемнение.fill((0, 0, 0, 150))
            экран.blit(затемнение, (0, 0))
            т1 = шрифт_большой.render("GAME OVER", True, КРАСНЫЙ)
            т2 = шрифт_средний.render(f"Счёт: {счет}  |  Нажми R для рестарта", True, БЕЛЫЙ)
            экран.blit(т1, (ШИРИНА//2 - т1.get_width()//2, ВЫСОТА//2 - 50))
            экран.blit(т2, (ШИРИНА//2 - т2.get_width()//2, ВЫСОТА//2 + 20))

        # Обновляем экран и ждём следующего кадра
        pygame.display.flip()
        часы.tick(скорость)


# Запускаем игру
if __name__ == "__main__":
    запустить()
